<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Shop - Recommendation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentUser = null;
        let currentView = 'login';
        let products = [];
        let recommendations = [];
        let categories = [];
        let searchTerm = '';
        let selectedCategory = '';
        let currentUserHistory = [];
        let userProfile = null;
        let cart = [];
        let userOrders = [];
        let adminStats = null;

        // Initialize
        function init() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                currentView = 'products';
                loadProducts();
                loadCategories();
                loadRecommendations();
                loadCart();  // –¢–æ–ª—å–∫–æ —ç—Ç–æ
            }

            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('token');
            if (resetToken) {
                const newPassword = prompt('Enter new password:');
                if (newPassword) {
                    resetPassword(resetToken, newPassword);
                }
            }

            render();
        }

        // API Calls
        async function loadUserHistory() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_URL}/api/users/${currentUser.user_id}/history`);
                const data = await response.json();
                currentUserHistory = data.history;
                if (currentView === 'history') render();
            } catch (err) {
                console.error('Error loading history:', err);
            }
        }

        async function updateUserProfile(username, preferences) {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_URL}/api/users/${currentUser.user_id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, preferences })
                });

                const data = await response.json();

                if (response.ok) {
                    userProfile = data.user;
                    currentUser.username = data.user.username;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    alert('‚úÖ Profile updated successfully!');
                    render();
                } else {
                    alert('‚ùå Error: ' + data.detail);
                }
            } catch (err) {
                alert('‚ùå Error updating profile: ' + err.message);
            }
        }

        async function loadUserStats() {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_URL}/api/users/${currentUser.user_id}/history`);
                const data = await response.json();

                const total = data.history.length;
                const likes = data.history.filter(h => h.interaction_type === 'like').length;
                const views = data.history.filter(h => h.interaction_type === 'view').length;

                document.getElementById('stats-interactions').textContent = total;
                document.getElementById('stats-likes').textContent = likes;
                document.getElementById('stats-views').textContent = views;
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        async function loadUserProfile() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_URL}/api/users/${currentUser.user_id}`);
                const data = await response.json();
                userProfile = data;
                if (currentView === 'profile') render();
            } catch (err) {
                console.error('Error loading profile:', err);
            }
        }


        async function register(username, email, password) {
            try {
                const response = await fetch(`${API_URL}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password, preferences: [] })
                });
                const data = await response.json();
                if (response.ok) {
                    alert('Registration successful! Please login.');
                    currentView = 'login';
                    render();
                } else {
                    alert(data.detail || 'Registration failed');
                }
            } catch (err) {
                alert('Registration failed: ' + err.message);
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            currentView = 'login';
            products = [];
            recommendations = [];
            render();
        }

        async function loadProducts() {
            try {
                let url = `${API_URL}/api/products`;
                const params = new URLSearchParams();
                if (searchTerm) params.append('search', searchTerm);
                if (selectedCategory) params.append('category', selectedCategory);
                if (params.toString()) url += `?${params.toString()}`;

                const response = await fetch(url);
                const data = await response.json();
                products = data.products;
                render();
            } catch (err) {
                console.error('Error loading products:', err);
            }
        }

        async function loadRecommendations() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_URL}/api/recommendations/${currentUser.user_id}?n=8`);
                const data = await response.json();
                recommendations = data.recommendations;
                render();
            } catch (err) {
                console.error('Error loading recommendations:', err);
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/api/categories`);
                const data = await response.json();
                categories = data.categories;
                render();
            } catch (err) {
                console.error('Error loading categories:', err);
            }
        }

        async function trackInteraction(productId, type) {
            if (!currentUser) return;
            try {
                await fetch(`${API_URL}/api/interactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.user_id,
                        product_id: productId,
                        interaction_type: type
                    })
                });
                if (type === 'like') {
                    loadRecommendations();
                }
            } catch (err) {
                console.error('Error tracking interaction:', err);
            }
        }

        // ==================== –ù–û–í–´–ï API –§–£–ù–ö–¶–ò–ò ====================

        // CART FUNCTIONS
        async function loadCart() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_URL}/api/cart/${currentUser.user_id}`);
                const data = await response.json();
                cart = data.items || [];
                if (currentView === 'cart') render();
            } catch (err) {
                console.error('Error loading cart:', err);
            }
        }

        async function addToCart(productId, quantity = 1) {
            if (!currentUser) {
                alert('Please login to add items to cart');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/cart/${currentUser.user_id}/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: productId, quantity })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úÖ Added to cart!');
                    loadCart();
                } else {
                    alert('‚ùå ' + data.detail);
                }
            } catch (err) {
                alert('Error adding to cart: ' + err.message);
            }
        }

        async function updateCartQuantity(productId, quantity) {
            try {
                const response = await fetch(`${API_URL}/api/cart/${currentUser.user_id}/items/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity })
                });

                if (response.ok) {
                    loadCart();
                }
            } catch (err) {
                console.error('Error updating cart:', err);
            }
        }

        async function removeFromCart(productId) {
            try {
                await fetch(`${API_URL}/api/cart/${currentUser.user_id}/items/${productId}`, {
                    method: 'DELETE'
                });
                loadCart();
            } catch (err) {
                console.error('Error removing from cart:', err);
            }
        }

        async function checkout() {
            const address = prompt('Enter shipping address:');
            if (!address) return;

            const paymentMethod = prompt('Enter payment method (credit_card/paypal/cash):');
            if (!paymentMethod) return;

            try {
                const response = await fetch(`${API_URL}/api/checkout/${currentUser.user_id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shipping_address: address,
                        payment_method: paymentMethod
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`‚úÖ Order placed successfully! Order ID: ${data.order_id}\nTotal: $${data.total}`);
                    loadCart();
                    currentView = 'orders';
                    loadOrders();
                    render();
                } else {
                    alert('‚ùå ' + data.detail);
                }
            } catch (err) {
                alert('Error placing order: ' + err.message);
            }
        }

        // ORDER FUNCTIONS
        async function loadOrders() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_URL}/api/orders/${currentUser.user_id}`);
                const data = await response.json();
                userOrders = data.orders || [];
                if (currentView === 'orders') render();
            } catch (err) {
                console.error('Error loading orders:', err);
            }
        }

        // PASSWORD RESET FUNCTIONS
        async function forgotPassword() {
            const email = prompt('Enter your email address:');
            if (!email) return;

            try {
                const response = await fetch(`${API_URL}/api/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();
                alert(data.message);
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function resetPassword(token, newPassword) {
            try {
                const response = await fetch(`${API_URL}/api/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, new_password: newPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úÖ ' + data.message);
                    currentView = 'login';
                    render();
                } else {
                    alert('‚ùå ' + data.detail);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // ADMIN FUNCTIONS
        async function loadAdminStats() {
            if (!currentUser || !currentUser.is_admin) return;

            try {
                const response = await fetch(`${API_URL}/api/admin/stats?admin_user_id=${currentUser.user_id}`);
                const data = await response.json();
                adminStats = data;
                if (currentView === 'admin') {
                    render();
                    // Load stock by category after render
                    setTimeout(loadStockByCategory, 100);
                }
            } catch (err) {
                console.error('Error loading admin stats:', err);
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å stock —Ç–æ–≤–∞—Ä–∞
        async function editProductStock(productId, currentStock) {
            const newStock = prompt(`Current stock: ${currentStock}\nEnter new stock quantity:`, currentStock);
            if (newStock === null) return;

            const quantity = parseInt(newStock);
            if (isNaN(quantity) || quantity < 0) {
                alert('Please enter a valid number');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/products/${productId}?admin_user_id=${currentUser.user_id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock_quantity: quantity })
                });

                if (response.ok) {
                    alert('‚úÖ Stock updated successfully!');
                    loadAdminStats(); // Reload stats
                } else {
                    const data = await response.json();
                    alert('‚ùå ' + data.detail);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –∞–¥–º–∏–Ω–∞
        async function loadAllProductsForAdmin() {
            try {
                const response = await fetch(`${API_URL}/api/products`);
                const data = await response.json();

                const productsList = document.getElementById('admin-products-list');
                productsList.innerHTML = `
            <div class="mb-4">
                <button onclick="showAddProductForm()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 w-full">
                    ‚ûï Add New Product
                </button>
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto">
                ${data.products.map(p => `
                    <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50">
                        <div class="flex items-center gap-4 flex-1">
                            <img src="${p.image_url}" alt="${p.name}" class="w-16 h-16 object-cover rounded">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${p.name}</h4>
                                <p class="text-sm text-gray-600">${p.category} | $${p.price}</p>
                                <p class="text-sm ${p.stock_quantity < 10 ? 'text-red-600' : 'text-green-600'}">
                                    Stock: ${p.stock_quantity}
                                </p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editProduct('${p._id}')" 
                                    class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="deleteProduct('${p._id}', '${p.name}')" 
                                    class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
            } catch (err) {
                alert('Error loading products: ' + err.message);
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä
        async function editProduct(productId) {
            try {
                const response = await fetch(`${API_URL}/api/products/${productId}`);
                const product = await response.json();

                const name = prompt('Product name:', product.name);
                if (!name) return;

                const price = parseFloat(prompt('Price:', product.price));
                if (isNaN(price)) return;

                const stock = parseInt(prompt('Stock quantity:', product.stock_quantity));
                if (isNaN(stock)) return;

                const updateResponse = await fetch(`${API_URL}/api/admin/products/${productId}?admin_user_id=${currentUser.user_id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        price: price,
                        stock_quantity: stock
                    })
                });

                if (updateResponse.ok) {
                    alert('‚úÖ Product updated!');
                    loadAllProductsForAdmin();
                    loadAdminStats();
                } else {
                    const data = await updateResponse.json();
                    alert('‚ùå ' + data.detail);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function loadStockByCategory() {
            try {
                const response = await fetch(`${API_URL}/api/products`);
                const data = await response.json();

                // Group by category and sum stock
                const stockByCategory = {};
                data.products.forEach(p => {
                    if (!stockByCategory[p.category]) {
                        stockByCategory[p.category] = 0;
                    }
                    stockByCategory[p.category] += p.stock_quantity || 0;
                });

                // Sort by stock quantity
                const sorted = Object.entries(stockByCategory)
                    .sort((a, b) => b[1] - a[1]);

                const container = document.getElementById('stock-by-category');
                if (container) {
                    container.innerHTML = sorted.map(([category, stock]) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">
                            ${category === 'Electronics' ? 'üíª' :
                            category === 'Books' ? 'üìö' :
                                category === 'Clothing' ? 'üëï' :
                                    category === 'Sports' ? '‚öΩ' :
                                        category === 'Home & Garden' ? 'üè°' :
                                            category === 'Beauty' ? 'üíÑ' :
                                                category === 'Toys' ? 'üß∏' : 'üõçÔ∏è'}
                        </span>
                        <span class="font-medium text-gray-700">${category}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl font-bold ${stock < 100 ? 'text-red-600' : stock < 300 ? 'text-yellow-600' : 'text-green-600'}">
                            ${stock}
                        </span>
                        <span class="text-sm text-gray-500">units</span>
                    </div>
                </div>
            `).join('');
                }
            } catch (err) {
                console.error('Error loading stock by category:', err);
            }
        }

        // –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
        async function deleteProduct(productId, productName) {
            if (!confirm(`Are you sure you want to delete "${productName}"?`)) return;

            try {
                const response = await fetch(`${API_URL}/api/admin/products/${productId}?admin_user_id=${currentUser.user_id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('‚úÖ Product deleted!');
                    loadAllProductsForAdmin();
                    loadAdminStats();
                } else {
                    const data = await response.json();
                    alert('‚ùå ' + data.detail);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // ==================== –û–ë–ù–û–í–ò–¢–ï —Ñ—É–Ω–∫—Ü–∏—é login ====================
        async function login(email, password) {
            try {
                const response = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    currentUser = data;
                    localStorage.setItem('currentUser', JSON.stringify(data));
                    currentView = 'products';
                    loadProducts();
                    loadCategories();
                    loadRecommendations();
                    loadCart();
                    render();
                } else {
                    alert(data.detail || 'Login failed');
                }
            } catch (err) {
                alert('Login failed: ' + err.message);
            }
        }



        // Render Functions
        function render() {
            const app = document.getElementById('app');

            if (currentView === 'login') {
                app.innerHTML = renderLogin();
            } else if (currentView === 'register') {
                app.innerHTML = renderRegister();
            } else {
                app.innerHTML = renderMain();
            }

            attachEventListeners();
        }

        function renderLogin() {
            return `
        <div class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">E-Shop</h1>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input id="login-email" type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="alice@example.com" value="alice@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input id="login-password" type="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="password123" value="password123">
                    </div>
                    <button id="login-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                        Login
                    </button>
                    <button onclick="forgotPassword()" class="w-full text-blue-600 text-sm hover:underline">
                        Forgot Password?
                    </button>
                </div>
                <p class="text-center mt-4 text-sm text-gray-600">
                    Don't have an account? 
                    <button id="goto-register" class="text-blue-600 font-semibold hover:underline">Register</button>
                </p>
                <div class="mt-6 p-3 bg-gray-100 rounded-lg text-xs text-gray-600">
                    <p class="font-semibold mb-1">Test credentials:</p>
                    <p>User: alice@example.com / password123</p>
                    <p>Admin: admin@eshop.com / admin123</p>
                </div>
            </div>
        </div>
    `;
        }

        function renderRegister() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Create Account</h1>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input id="register-username" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input id="register-email" type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input id="register-password" type="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                            <button id="register-btn" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition">
                                Register
                            </button>
                        </div>
                        <p class="text-center mt-4 text-sm text-gray-600">
                            Already have an account? 
                            <button id="goto-login" class="text-purple-600 font-semibold hover:underline">Login</button>
                        </p>
                    </div>
                </div>
            `;
        }

        function renderMain() {
            const isAdmin = currentUser.is_admin || false;

            return `
        <header class="bg-white shadow-md sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <h1 class="text-2xl font-bold text-blue-600">E-Shop</h1>
                <div class="flex items-center gap-4">
                    <button id="view-products" class="px-4 py-2 ${currentView === 'products' ? 'bg-blue-600 text-white' : 'bg-blue-100 text-blue-700'} rounded-lg font-medium hover:bg-blue-200 transition">
                        üì¶ Products
                    </button>
                    <button id="view-recommendations" class="px-4 py-2 ${currentView === 'recommendations' ? 'bg-purple-600 text-white' : 'bg-purple-100 text-purple-700'} rounded-lg font-medium hover:bg-purple-200 transition">
                        ‚≠ê Recommendations
                    </button>
                    <button id="view-cart" class="px-4 py-2 ${currentView === 'cart' ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700'} rounded-lg font-medium hover:bg-green-200 transition relative">
                        üõí Cart
                        ${cart.length > 0 ? `<span class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">${cart.length}</span>` : ''}
                    </button>
                    <button id="view-orders" class="px-4 py-2 ${currentView === 'orders' ? 'bg-yellow-600 text-white' : 'bg-yellow-100 text-yellow-700'} rounded-lg font-medium hover:bg-yellow-200 transition">
                        üìã Orders
                    </button>
                    <button id="view-history" class="px-4 py-2 ${currentView === 'history' ? 'bg-indigo-600 text-white' : 'bg-indigo-100 text-indigo-700'} rounded-lg font-medium hover:bg-indigo-200 transition">
                        üìú History
                    </button>
                    <button id="view-profile" class="px-4 py-2 ${currentView === 'profile' ? 'bg-pink-600 text-white' : 'bg-pink-100 text-pink-700'} rounded-lg font-medium hover:bg-pink-200 transition">
                        üë§ Profile
                    </button>
                    ${isAdmin ? `<button id="view-admin" class="px-4 py-2 ${currentView === 'admin' ? 'bg-red-600 text-white' : 'bg-red-100 text-red-700'} rounded-lg font-medium hover:bg-red-200 transition">
                        üîß Admin
                    </button>` : ''}
                    <button id="logout-btn" class="text-red-500 hover:text-red-700 font-medium">üö™ Logout</button>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 py-6">
            ${currentView === 'products' ? renderProductsView() :
                    currentView === 'recommendations' ? renderRecommendationsView() :
                        currentView === 'cart' ? renderCartView() :
                            currentView === 'orders' ? renderOrdersView() :
                                currentView === 'history' ? renderHistoryView() :
                                    currentView === 'profile' ? renderProfileView() :
                                        currentView === 'admin' ? renderAdminView() : ''}
        </div>
    `;
        }

        function renderProfileView() {
            if (!userProfile) {
                loadUserProfile();
                return '<div class="text-center py-16">Loading...</div>';
            }

            return `
        <div class="max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold mb-8 text-gray-800">My Profile</h2>
            
            <!-- Profile Card -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-xl p-8 mb-8 text-white">
                <div class="flex items-center gap-6">
                    <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center text-4xl font-bold text-blue-600 shadow-lg">
                        ${userProfile.username.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <h3 class="text-3xl font-bold mb-2">${userProfile.username}</h3>
                        <p class="text-blue-100 text-lg">${userProfile.email}</p>
                        <p class="text-sm text-blue-200 mt-2">üìÖ Member since ${new Date(userProfile.created_at).toLocaleDateString()}</p>
                    </div>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 text-center transform hover:scale-105 transition">
                    <div class="text-5xl font-bold text-blue-600 mb-2" id="stats-interactions">-</div>
                    <div class="text-gray-600 font-medium">Total Interactions</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center transform hover:scale-105 transition">
                    <div class="text-5xl font-bold text-red-600 mb-2" id="stats-likes">-</div>
                    <div class="text-gray-600 font-medium">Products Liked</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center transform hover:scale-105 transition">
                    <div class="text-5xl font-bold text-green-600 mb-2" id="stats-views">-</div>
                    <div class="text-gray-600 font-medium">Products Viewed</div>
                </div>
            </div>
            
            <!-- Preferences Section -->
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div id="view-mode">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">üéØ Preferred Categories</h3>
                        <button id="edit-profile-btn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-blue-700 transition shadow-md font-semibold">
                            ‚úèÔ∏è Edit Profile
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        ${userProfile.preferences && userProfile.preferences.length > 0
                    ? userProfile.preferences.map(pref =>
                        `<span class="px-5 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-full font-semibold shadow-md text-sm">${pref}</span>`
                    ).join('')
                    : '<div class="text-center w-full py-8"><span class="text-gray-400 italic text-lg">No preferences set yet</span><br><span class="text-gray-500 text-sm mt-2">Click "Edit Profile" to add your favorite categories!</span></div>'
                }
                    </div>
                </div>
                
                <!-- Edit Mode -->
                <div id="edit-mode" style="display: none;">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">‚úèÔ∏è Edit Your Profile</h3>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                        <input id="edit-username" type="text" value="${userProfile.username}" 
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg transition">
                    </div>
                    
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">Select Your Favorite Categories</label>
                        <p class="text-sm text-gray-500 mb-4">Choose categories you're interested in to get better recommendations</p>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            ${categories.map(cat => {
                    const isChecked = userProfile.preferences.includes(cat);
                    return `
                                <label class="group cursor-pointer">
                                    <input type="checkbox" class="category-checkbox hidden" value="${cat}" ${isChecked ? 'checked' : ''}>
                                    <div class="relative p-4 border-2 rounded-xl transition-all duration-200 ${isChecked
                            ? 'bg-gradient-to-br from-blue-500 to-purple-500 border-blue-500 text-white shadow-lg scale-105'
                            : 'bg-white border-gray-300 hover:border-blue-400 hover:shadow-md'
                        }">
                                        <div class="text-center">
                                            <div class="text-2xl mb-2">
                                                ${cat === 'Electronics' ? 'üíª' :
                            cat === 'Books' ? 'üìö' :
                                cat === 'Clothing' ? 'üëï' :
                                    cat === 'Sports' ? '‚öΩ' :
                                        cat === 'Home & Garden' ? 'üè°' :
                                            cat === 'Beauty' ? 'üíÑ' :
                                                cat === 'Toys' ? 'üß∏' : 'üõçÔ∏è'}
                                            </div>
                                            <div class="font-semibold text-sm">${cat}</div>
                                        </div>
                                        ${isChecked ? '<div class="absolute top-2 right-2 w-6 h-6 bg-white rounded-full flex items-center justify-center"><span class="text-blue-500 font-bold">‚úì</span></div>' : ''}
                                    </div>
                                </label>
                            `}).join('')}
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button id="save-profile-btn" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-4 rounded-xl hover:from-green-600 hover:to-green-700 transition font-bold text-lg shadow-lg transform hover:scale-105">
                            ‚úì Save Changes
                        </button>
                        <button id="cancel-edit-btn" class="flex-1 bg-gray-300 text-gray-700 px-6 py-4 rounded-xl hover:bg-gray-400 transition font-bold text-lg">
                            ‚úó Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
        }

        function renderCartView() {
            if (cart.length === 0) {
                return `
            <div class="text-center py-16">
                <div class="text-6xl mb-4">üõí</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Your cart is empty</h2>
                <p class="text-gray-600 mb-6">Add some products to your cart!</p>
                <button onclick="currentView='products'; render();" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                    Browse Products
                </button>
            </div>
        `;
            }

            const total = cart.reduce((sum, item) => sum + item.subtotal, 0);

            return `
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Shopping Cart</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                ${cart.map(item => `
                    <div class="bg-white rounded-lg shadow p-4 flex gap-4">
                        <img src="${item.image_url}" alt="${item.name}" class="w-24 h-24 object-cover rounded">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg mb-1">${item.name}</h3>
                            <p class="text-gray-600 mb-2">$${item.price} each</p>
                            <div class="flex items-center gap-3">
                                <button onclick="updateCartQuantity('${item._id}', ${item.quantity - 1})" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">-</button>
                                <span class="font-medium">${item.quantity}</span>
                                <button onclick="updateCartQuantity('${item._id}', ${item.quantity + 1})" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">+</button>
                                <button onclick="removeFromCart('${item._id}')" class="ml-auto text-red-500 hover:text-red-700">
                                    üóëÔ∏è Remove
                                </button>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold text-blue-600">$${item.subtotal.toFixed(2)}</div>
                            <div class="text-sm text-gray-500">${item.stock_quantity} in stock</div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow p-6 sticky top-24">
                    <h3 class="text-xl font-bold mb-4">Order Summary</h3>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span class="font-medium">$${total.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Shipping:</span>
                            <span class="font-medium">$10.00</span>
                        </div>
                        <div class="border-t pt-2 flex justify-between text-lg font-bold">
                            <span>Total:</span>
                            <span class="text-blue-600">$${(total + 10).toFixed(2)}</span>
                        </div>
                    </div>
                    <button onclick="checkout()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 mb-2">
                        Proceed to Checkout
                    </button>
                    <button onclick="currentView='products'; render();" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">
                        Continue Shopping
                    </button>
                </div>
            </div>
        </div>
    `;
        }

        function renderOrdersView() {
            if (userOrders.length === 0) {
                return `
            <div class="text-center py-16">
                <div class="text-6xl mb-4">üìã</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">No orders yet</h2>
                <p class="text-gray-600">Start shopping to see your orders here!</p>
            </div>
        `;
            }

            return `
        <h2 class="text-3xl font-bold mb-6 text-gray-800">My Orders</h2>
        
        <div class="space-y-4">
            ${userOrders.map(order => `
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-lg">Order #${order._id.slice(-8)}</h3>
                            <p class="text-sm text-gray-600">${new Date(order.created_at).toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold text-blue-600">$${order.total}</div>
                            <span class="inline-block px-3 py-1 rounded-full text-sm font-medium ${order.status === 'confirmed' ? 'bg-green-100 text-green-700' :
                    order.status === 'shipped' ? 'bg-blue-100 text-blue-700' :
                        order.status === 'delivered' ? 'bg-purple-100 text-purple-700' :
                            'bg-red-100 text-red-700'
                }">
                                ${order.status.toUpperCase()}
                            </span>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="font-semibold mb-2">Items:</h4>
                        ${order.items.map(item => `
                            <div class="flex justify-between text-sm mb-1">
                                <span>${item.product_name} x${item.quantity}</span>
                                <span>$${item.subtotal.toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="border-t mt-4 pt-4 text-sm text-gray-600">
                        <p><strong>Shipping:</strong> ${order.shipping_address}</p>
                        <p><strong>Payment:</strong> ${order.payment_method}</p>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
        }

        function renderAdminView() {
            if (!currentUser.is_admin) {
                return '<div class="text-center py-16 text-red-500">Access Denied</div>';
            }

            if (!adminStats) {
                loadAdminStats();
                return '<div class="text-center py-16">Loading...</div>';
            }

            return `
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Admin Dashboard</h2>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-6 shadow-lg">
                <div class="text-4xl font-bold mb-2">${adminStats.total_users}</div>
                <div class="text-sm opacity-90">Total Users</div>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg p-6 shadow-lg">
                <div class="text-4xl font-bold mb-2">${adminStats.total_products}</div>
                <div class="text-sm opacity-90">Total Products</div>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-6 shadow-lg">
                <div class="text-4xl font-bold mb-2">${adminStats.total_orders}</div>
                <div class="text-sm opacity-90">Total Orders</div>
            </div>
            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-lg p-6 shadow-lg">
                <div class="text-4xl font-bold mb-2">$${adminStats.total_revenue}</div>
                <div class="text-sm opacity-90">Total Revenue</div>
            </div>
        </div>
        
        <!-- Low Stock Alert -->
        ${adminStats.low_stock_products.length > 0 ? `
        <div class="bg-red-50 border-l-4 border-red-500 p-6 mb-6 rounded-r-lg shadow">
            <div class="flex items-center mb-3">
                <span class="text-2xl mr-2">‚ö†Ô∏è</span>
                <h3 class="font-bold text-red-700 text-lg">Low Stock Alert</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                ${adminStats.low_stock_products.slice(0, 6).map(p => `
                    <div class="flex justify-between items-center bg-white p-3 rounded">
                        <div>
                            <span class="font-medium text-gray-800">${p.name}</span>
                            <span class="text-red-600 font-bold ml-2">(${p.stock_quantity} left)</span>
                        </div>
                        <button onclick="editProductStock('${p._id}', ${p.stock_quantity})" 
                                class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                            Update Stock
                        </button>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Popular Categories -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="font-bold text-xl mb-4 text-gray-800 flex items-center">
                    <span class="text-2xl mr-2">üìä</span> Popular Categories
                </h3>
                <div class="space-y-3">
                    ${adminStats.popular_categories.map(cat => {
                const percentage = (cat.count / adminStats.total_products * 100).toFixed(1);
                return `
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="font-medium text-gray-700">${cat._id}</span>
                                <span class="text-gray-600">${cat.count} products (${percentage}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            </div>
            
            <!-- Stock Quantities by Category -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="font-bold text-xl mb-4 text-gray-800 flex items-center">
                    <span class="text-2xl mr-2">üì¶</span> Stock Quantities
                </h3>
                <div class="space-y-3" id="stock-by-category">
                    <p class="text-gray-500">Loading...</p>
                </div>
            </div>
        </div>
        
        <!-- Product Management -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-gray-800 flex items-center">
                    <span class="text-2xl mr-2">üõçÔ∏è</span> Product Management
                </h3>
            </div>
            <button onclick="loadAllProductsForAdmin()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 mb-4 font-semibold shadow-md">
                üì¶ Manage All Products
            </button>
            <div id="admin-products-list"></div>
        </div>
    `;
        }
        function renderHistoryView() {
            const history = currentUserHistory || [];

            return `
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Your Activity History</h2>
        ${history.length === 0 ?
                    '<p class="text-gray-500">No activity yet. Start browsing products!</p>' :
                    `<div class="space-y-4">
                ${history.map(item => `
                    <div class="bg-white rounded-lg shadow p-4 flex gap-4">
                        <img src="${item.product.image_url}" alt="${item.product.name}" class="w-24 h-24 object-cover rounded">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg">${item.product.name}</h3>
                            <p class="text-sm text-gray-600 mb-2">${item.product.description}</p>
                            <div class="flex items-center gap-4 text-sm">
                                <span class="px-2 py-1 rounded ${item.interaction_type === 'like' ? 'bg-red-100 text-red-700' :
                            item.interaction_type === 'rating' ? 'bg-yellow-100 text-yellow-700' :
                                'bg-blue-100 text-blue-700'
                        }">
                                    ${item.interaction_type === 'like' ? '‚ù§Ô∏è Liked' :
                            item.interaction_type === 'rating' ? `‚≠ê Rated ${item.rating}/5` :
                                'üëÅÔ∏è Viewed'}
                                </span>
                                <span class="text-gray-500">${new Date(item.timestamp).toLocaleString()}</span>
                                <span class="font-bold text-blue-600">$${item.product.price}</span>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>`
                }
    `;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
        function showAddProductForm() {
            const name = prompt('Product name:');
            if (!name) return;

            const description = prompt('Product description:');
            if (!description) return;

            const category = prompt('Category (Electronics, Books, Clothing, Sports, Home & Garden, Beauty, Toys):');
            if (!category) return;

            const price = parseFloat(prompt('Price:'));
            if (isNaN(price)) {
                alert('Invalid price');
                return;
            }

            const stock = parseInt(prompt('Stock quantity:'));
            if (isNaN(stock)) {
                alert('Invalid stock quantity');
                return;
            }

            const imageUrl = prompt('Image URL (or leave empty):', 'https://via.placeholder.com/300x300?text=Product');

            addNewProduct(name, description, category, price, stock, imageUrl);
        }

        // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä
        async function addNewProduct(name, description, category, price, stock, imageUrl) {
            try {
                const response = await fetch(`${API_URL}/api/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        category: category,
                        price: price,
                        stock_quantity: stock,
                        image_url: imageUrl || 'https://via.placeholder.com/300x300?text=Product'
                    })
                });

                if (response.ok) {
                    alert('‚úÖ Product added successfully!');
                    loadAdminStats();
                    if (document.getElementById('admin-products-list').children.length > 0) {
                        loadAllProductsForAdmin();
                    }
                } else {
                    const data = await response.json();
                    alert('‚ùå ' + data.detail);
                }
            } catch (err) {
                alert('Error adding product: ' + err.message);
            }
        }

        function renderProductsView() {
            return `
                <div class="mb-6 bg-white p-4 rounded-lg shadow">
                    <div class="flex gap-4">
                        <input id="search-input" type="text" value="${searchTerm}" placeholder="Search products..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <select id="category-select" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">All Categories</option>
                            ${categories.map(cat => `<option value="${cat}" ${cat === selectedCategory ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                        <button id="search-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            üîç Search
                        </button>
                    </div>
                </div>

                <h2 class="text-2xl font-bold mb-6 text-gray-800">${selectedCategory || 'All Products'}</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${products.map(product => renderProductCard(product)).join('')}
                </div>
            `;
        }

        function renderRecommendationsView() {
            return `
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Recommended for You</h2>
                ${recommendations.length === 0 ?
                    '<p class="text-gray-500">No recommendations yet. Interact with products to get personalized suggestions!</p>' :
                    `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        ${recommendations.map(product => renderProductCard(product, true)).join('')}
                    </div>`
                }
            `;
        }

        function renderProductCard(product, showScore = false) {
            return `
                <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition transform hover:-translate-y-1">
                    <div class="h-48 bg-gray-200 flex items-center justify-center" onclick="trackInteraction('${product._id}', 'view')">
                        <img src="${product.image_url}" alt="${product.name}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-gray-800 text-lg line-clamp-2">${product.name}</h3>
                            <button onclick="trackInteraction('${product._id}', 'like')" class="text-gray-400 hover:text-red-500 transition">
                                ‚ù§Ô∏è
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">${product.description}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded">${product.category}</span>
                            <span class="text-xl font-bold text-blue-600">$${product.price}</span>
                        </div>
                        ${showScore && product.recommendation_score ?
                    `<div class="mt-2 text-sm text-purple-600 italic">
                                ‚≠ê Match: ${(product.recommendation_score * 20).toFixed(0)}%
                            </div>` : ''
                }
                    </div>
                </div>
            `;
        }

        function renderProductCard(product, showScore = false) {
            return `
        <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition transform hover:-translate-y-1">
            <div class="h-48 bg-gray-200 flex items-center justify-center" onclick="trackInteraction('${product._id}', 'view')">
                <img src="${product.image_url}" alt="${product.name}" class="w-full h-full object-cover">
            </div>
            <div class="p-4">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-gray-800 text-lg line-clamp-2">${product.name}</h3>
                    <button onclick="trackInteraction('${product._id}', 'like')" class="text-gray-400 hover:text-red-500 transition">
                        ‚ù§Ô∏è
                    </button>
                </div>
                <p class="text-sm text-gray-600 mb-3 line-clamp-2">${product.description}</p>
                <div class="flex justify-between items-center mb-3">
                    <span class="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded">${product.category}</span>
                    <span class="text-xl font-bold text-blue-600">$${product.price}</span>
                </div>
                
                <!-- Stock Info -->
                <div class="text-sm mb-3 ${product.stock_quantity < 10 ? 'text-red-600' : 'text-green-600'}">
                    ${product.stock_quantity > 0 ? `‚úì ${product.stock_quantity} in stock` : '‚úó Out of stock'}
                </div>
                
                <!-- Add to Cart Button -->
                <button 
                    onclick="addToCart('${product._id}')" 
                    ${product.stock_quantity === 0 ? 'disabled' : ''}
                    class="w-full py-2 rounded-lg font-medium transition ${product.stock_quantity > 0
                    ? 'bg-blue-600 text-white hover:bg-blue-700'
                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                }">
                    ${product.stock_quantity > 0 ? 'üõí Add to Cart' : 'Out of Stock'}
                </button>
                
                ${showScore && product.recommendation_score ?
                    `<div class="mt-2 text-sm text-purple-600 italic">
                        ‚≠ê Match: ${(product.recommendation_score * 20).toFixed(0)}%
                    </div>` : ''
                }
            </div>
        </div>
    `;
        }

        function attachEventListeners() {
            // Login
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.onclick = () => {
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    login(email, password);
                };
            }

            // Register
            const registerBtn = document.getElementById('register-btn');
            if (registerBtn) {
                registerBtn.onclick = () => {
                    const username = document.getElementById('register-username').value;
                    const email = document.getElementById('register-email').value;
                    const password = document.getElementById('register-password').value;
                    register(username, email, password);
                };
            }

            // Navigation
            const gotoRegister = document.getElementById('goto-register');
            if (gotoRegister) gotoRegister.onclick = () => { currentView = 'register'; render(); };

            const gotoLogin = document.getElementById('goto-login');
            if (gotoLogin) gotoLogin.onclick = () => { currentView = 'login'; render(); };

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.onclick = logout;

            const viewProducts = document.getElementById('view-products');
            if (viewProducts) viewProducts.onclick = () => { currentView = 'products'; render(); };

            const viewRecommendations = document.getElementById('view-recommendations');
            if (viewRecommendations) viewRecommendations.onclick = () => { currentView = 'recommendations'; render(); };

            // Search
            const searchBtn = document.getElementById('search-btn');
            if (searchBtn) {
                searchBtn.onclick = () => {
                    searchTerm = document.getElementById('search-input').value;
                    selectedCategory = document.getElementById('category-select').value;
                    loadProducts();
                };
            }

            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        searchTerm = searchInput.value;
                        loadProducts();
                    }
                };
            }

            const categorySelect = document.getElementById('category-select');
            if (categorySelect) {
                categorySelect.onchange = () => {
                    selectedCategory = categorySelect.value;
                    loadProducts();
                };
            }

            // History
            const viewHistory = document.getElementById('view-history');
            if (viewHistory) viewHistory.onclick = () => {
                currentView = 'history';
                loadUserHistory();
                render();
            }

            // Profile view
            const viewProfile = document.getElementById('view-profile');
            if (viewProfile) viewProfile.onclick = () => {
                currentView = 'profile';
                loadUserProfile();
                render();
                setTimeout(loadUserStats, 100);
            };

            // Edit profile mode
            const editProfileBtn = document.getElementById('edit-profile-btn');
            if (editProfileBtn) {
                editProfileBtn.onclick = () => {
                    document.getElementById('view-mode').style.display = 'none';
                    document.getElementById('edit-mode').style.display = 'block';

                    // Add checkbox listeners
                    const checkboxes = document.querySelectorAll('.category-checkbox');
                    checkboxes.forEach(cb => {
                        cb.onchange = (e) => {
                            const label = e.target.parentElement;
                            const div = label.querySelector('div');
                            if (e.target.checked) {
                                div.classList.remove('bg-white', 'border-gray-300', 'hover:border-blue-400', 'hover:shadow-md');
                                div.classList.add('bg-gradient-to-br', 'from-blue-500', 'to-purple-500', 'border-blue-500', 'text-white', 'shadow-lg', 'scale-105');
                                // Add checkmark
                                if (!div.querySelector('.absolute')) {
                                    div.innerHTML += '<div class="absolute top-2 right-2 w-6 h-6 bg-white rounded-full flex items-center justify-center"><span class="text-blue-500 font-bold">‚úì</span></div>';
                                }
                            } else {
                                div.classList.remove('bg-gradient-to-br', 'from-blue-500', 'to-purple-500', 'border-blue-500', 'text-white', 'shadow-lg', 'scale-105');
                                div.classList.add('bg-white', 'border-gray-300', 'hover:border-blue-400', 'hover:shadow-md');
                                // Remove checkmark
                                const checkmark = div.querySelector('.absolute');
                                if (checkmark) checkmark.remove();
                            }
                        };
                    });
                };
            }

            // Save profile
            const saveProfileBtn = document.getElementById('save-profile-btn');
            if (saveProfileBtn) {
                saveProfileBtn.onclick = () => {
                    const username = document.getElementById('edit-username').value;
                    const selectedPreferences = Array.from(document.querySelectorAll('.category-checkbox:checked'))
                        .map(cb => cb.value);

                    if (!username.trim()) {
                        alert('Username cannot be empty');
                        return;
                    }

                    updateUserProfile(username, selectedPreferences);
                };
            }

            // Cancel edit
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            if (cancelEditBtn) {
                cancelEditBtn.onclick = () => {
                    document.getElementById('view-mode').style.display = 'block';
                    document.getElementById('edit-mode').style.display = 'none';
                };
            }

            const viewCart = document.getElementById('view-cart');
            if (viewCart) viewCart.onclick = () => {
                currentView = 'cart';
                loadCart();
                render();
            };

            const viewOrders = document.getElementById('view-orders');
            if (viewOrders) viewOrders.onclick = () => {
                currentView = 'orders';
                loadOrders();
                render();
            };

            const viewAdmin = document.getElementById('view-admin');
            if (viewAdmin) viewAdmin.onclick = () => {
                currentView = 'admin';
                loadAdminStats();
                render();
            };




        }

        // Start the app
        init();
    </script>
</body>

</html>